<!-- CVE Details Modal - Follows WD standards for accessibility and responsive design -->
<div 
  x-data="cveModal()"
  x-show="isOpen"
  x-cloak
  @keydown.window="handleKeydown($event)"
  class="modal-overlay"
  data-modal="cve-details"
  role="dialog"
  aria-modal="true"
  aria-labelledby="modal-title"
  aria-describedby="modal-description"
  x-transition:enter="modal-enter"
  x-transition:enter-start="modal-enter-start"
  x-transition:enter-end="modal-enter-end"
  x-transition:leave="modal-leave"
  x-transition:leave-start="modal-leave-start"
  x-transition:leave-end="modal-leave-end"
>
  <!-- Modal Backdrop -->
  <div 
    class="modal-backdrop" 
    @click="closeModal()"
    aria-hidden="true"
  ></div>

  <!-- Modal Container -->
  <div class="modal-container">
    <div class="modal-content">
      <!-- Modal Header -->
      <header class="modal-header">
        <div class="modal-title-section">
          <h2 id="modal-title" class="modal-title" x-show="vulnerability">
            <span x-text="vulnerability?.cveId"></span>
            <span class="severity-badge" 
                  :class="'severity-' + vulnerability?.severity?.toLowerCase()" 
                  x-text="vulnerability?.severity"
                  x-show="vulnerability?.severity">
            </span>
          </h2>
          <p id="modal-description" class="modal-description" x-show="vulnerability" x-text="vulnerability?.title"></p>
        </div>
        
        <!-- Close Button -->
        <button 
          @click="closeModal()" 
          class="modal-close"
          aria-label="Close CVE details modal"
          type="button"
        >
          <svg class="icon" aria-hidden="true" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </header>

      <!-- Loading State -->
      <div x-show="loading" class="modal-loading" role="status" aria-live="polite">
        <div class="loading-spinner" aria-hidden="true"></div>
        <span class="loading-text">Loading CVE details...</span>
      </div>

      <!-- Error State -->
      <div x-show="error" class="modal-error" role="alert" aria-live="assertive">
        <div class="error-icon" aria-hidden="true">⚠️</div>
        <div class="error-content">
          <h3>Error Loading CVE Details</h3>
          <p x-text="error"></p>
          <button @click="closeModal()" class="btn btn-secondary">Close</button>
        </div>
      </div>

      <!-- Modal Content -->
      <div x-show="!loading && !error && vulnerability" class="modal-body">
        <!-- Tab Navigation -->
        <nav class="tab-nav" role="tablist" aria-label="CVE details sections">
          <button 
            @click="switchTab('overview')"
            :class="{ 'tab-active': activeTab === 'overview' }"
            :aria-selected="activeTab === 'overview'"
            role="tab"
            id="tab-overview"
            aria-controls="panel-overview"
            class="tab-button"
            type="button"
          >
            Overview
          </button>
          <button 
            @click="switchTab('technical')"
            :class="{ 'tab-active': activeTab === 'technical' }"
            :aria-selected="activeTab === 'technical'"
            role="tab"
            id="tab-technical"
            aria-controls="panel-technical"
            class="tab-button"
            type="button"
          >
            Technical Details
          </button>
          <button 
            @click="switchTab('timeline')"
            :class="{ 'tab-active': activeTab === 'timeline' }"
            :aria-selected="activeTab === 'timeline'"
            role="tab"
            id="tab-timeline"
            aria-controls="panel-timeline"
            class="tab-button"
            type="button"
          >
            Timeline
          </button>
          <button 
            @click="switchTab('references')"
            :class="{ 'tab-active': activeTab === 'references' }"
            :aria-selected="activeTab === 'references'"
            role="tab"
            id="tab-references"
            aria-controls="panel-references"
            class="tab-button"
            type="button"
          >
            References
          </button>
        </nav>

        <!-- Tab Panels -->
        <div class="tab-content">
          <!-- Overview Panel -->
          <div 
            x-show="activeTab === 'overview'"
            id="panel-overview"
            role="tabpanel"
            aria-labelledby="tab-overview"
            class="tab-panel"
          >
            <div class="overview-grid">
              <!-- Risk Summary Card -->
              <div class="risk-summary card">
                <h3 class="card-title">Risk Assessment</h3>
                <div class="risk-metrics">
                  <div class="metric">
                    <span class="metric-label">CVSS Score</span>
                    <span class="metric-value cvss-score" 
                          :class="getSeverityClass(vulnerability?.cvssScore || 0)"
                          x-text="vulnerability?.cvssScore || 'N/A'">
                    </span>
                    <span class="metric-description" x-text="getRiskLevelText(vulnerability?.cvssScore || 0)"></span>
                  </div>
                  <div class="metric">
                    <span class="metric-label">EPSS Score</span>
                    <span class="metric-value epss-score" x-text="vulnerability?.epssPercentile ? vulnerability.epssPercentile + '%' : 'N/A'"></span>
                    <span class="metric-description">Exploit Prediction</span>
                  </div>
                  <div class="metric">
                    <span class="metric-label">Risk Score</span>
                    <span class="metric-value risk-score" 
                          :class="'risk-' + Math.floor((vulnerability?.riskScore || 0) / 20)"
                          x-text="vulnerability?.riskScore || 'N/A'">
                    </span>
                    <span class="metric-description">Composite Risk</span>
                  </div>
                </div>
              </div>

              <!-- Exploitation Status Card -->
              <div class="exploitation-status card">
                <h3 class="card-title">Exploitation Status</h3>
                <div class="status-indicator" 
                     :class="'status-' + vulnerability?.exploitationStatus?.toLowerCase()"
                     x-text="vulnerability?.exploitationStatus">
                </div>
                <p class="status-description" x-show="vulnerability?.exploitationStatus === 'ACTIVE'">
                  This vulnerability has known active exploitation in the wild.
                </p>
                <p class="status-description" x-show="vulnerability?.exploitationStatus === 'POC'">
                  Proof-of-concept code is available for this vulnerability.
                </p>
                <p class="status-description" x-show="vulnerability?.exploitationStatus === 'UNPROVEN'">
                  No known exploitation of this vulnerability.
                </p>
              </div>

              <!-- Key Details Card -->
              <div class="key-details card full-width">
                <h3 class="card-title">Vulnerability Details</h3>
                <div class="details-grid">
                  <div class="detail-item">
                    <dt>Published</dt>
                    <dd>
                      <time :datetime="vulnerability?.publishedDate" x-text="formatDate(vulnerability?.publishedDate || '')"></time>
                    </dd>
                  </div>
                  <div class="detail-item">
                    <dt>Last Modified</dt>
                    <dd>
                      <time :datetime="vulnerability?.lastModifiedDate" x-text="formatDate(vulnerability?.lastModifiedDate || '')"></time>
                    </dd>
                  </div>
                  <div class="detail-item" x-show="vulnerability?.vendors?.length">
                    <dt>Affected Vendors</dt>
                    <dd>
                      <template x-for="vendor in vulnerability?.vendors?.slice(0, 3)" :key="vendor">
                        <span class="vendor-tag" x-text="vendor"></span>
                      </template>
                      <span x-show="vulnerability?.vendors?.length > 3" class="vendor-more">
                        +<span x-text="vulnerability.vendors.length - 3"></span> more
                      </span>
                    </dd>
                  </div>
                  <div class="detail-item" x-show="vulnerability?.products?.length">
                    <dt>Affected Products</dt>
                    <dd>
                      <template x-for="product in vulnerability?.products?.slice(0, 3)" :key="product">
                        <span class="product-tag" x-text="product"></span>
                      </template>
                      <span x-show="vulnerability?.products?.length > 3" class="product-more">
                        +<span x-text="vulnerability.products.length - 3"></span> more
                      </span>
                    </dd>
                  </div>
                </div>
              </div>

              <!-- Description Card -->
              <div class="description card full-width">
                <h3 class="card-title">Description</h3>
                <p class="vulnerability-description" x-text="vulnerability?.description"></p>
              </div>
            </div>
          </div>

          <!-- Technical Details Panel -->
          <div 
            x-show="activeTab === 'technical'"
            id="panel-technical"
            role="tabpanel"
            aria-labelledby="tab-technical"
            class="tab-panel"
          >
            <div class="technical-grid">
              <!-- CVSS Metrics -->
              <div class="cvss-metrics card">
                <h3 class="card-title">CVSS v3.1 Metrics</h3>
                <div class="metrics-list">
                  <template x-for="metric in getCvssMetrics(vulnerability)" :key="metric.label">
                    <div class="metric-row">
                      <span class="metric-label" x-text="metric.label"></span>
                      <span class="metric-value" x-text="metric.value"></span>
                    </div>
                  </template>
                </div>
                <div class="cvss-vector" x-show="vulnerability?.cvssMetrics?.length && vulnerability.cvssMetrics[0]?.vectorString">
                  <h4>Vector String</h4>
                  <code class="vector-string" x-text="vulnerability?.cvssMetrics?.[0]?.vectorString"></code>
                </div>
              </div>

              <!-- CWE Information -->
              <div class="cwe-info card" x-show="vulnerability?.tags?.some(tag => tag.startsWith('CWE-'))">
                <h3 class="card-title">Common Weakness Enumeration</h3>
                <ul class="cwe-list">
                  <template x-for="cweId in vulnerability?.tags?.filter(tag => tag.startsWith('CWE-'))" :key="cweId">
                    <li class="cwe-item">
                      <a :href="'https://cwe.mitre.org/data/definitions/' + cweId.replace('CWE-', '') + '.html'" 
                         target="_blank" 
                         rel="noopener noreferrer"
                         x-text="cweId"
                         class="cwe-link">
                      </a>
                    </li>
                  </template>
                </ul>
              </div>

              <!-- Affected Products -->
              <div class="products-info card full-width" x-show="vulnerability?.products?.length">
                <h3 class="card-title">Affected Products</h3>
                <div class="product-list">
                  <template x-for="product in vulnerability?.products?.slice(0, 10)" :key="product">
                    <span class="product-tag" x-text="product"></span>
                  </template>
                  <div x-show="vulnerability?.products?.length > 10" class="product-more">
                    <span x-text="vulnerability.products.length - 10"></span> more products...
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Timeline Panel -->
          <div 
            x-show="activeTab === 'timeline'"
            id="panel-timeline"
            role="tabpanel"
            aria-labelledby="tab-timeline"
            class="tab-panel"
          >
            <div class="timeline-container">
              <h3 class="timeline-title">Vulnerability Timeline</h3>
              <div class="timeline">
                <template x-for="event in getTimelineEvents(vulnerability)" :key="event.date + event.event">
                  <div class="timeline-event" :class="'event-' + event.type">
                    <div class="timeline-marker" :class="'marker-' + event.type"></div>
                    <div class="timeline-content">
                      <time class="timeline-date" :datetime="event.date" x-text="formatDate(event.date)"></time>
                      <p class="timeline-description" x-text="event.event"></p>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- References Panel -->
          <div 
            x-show="activeTab === 'references'"
            id="panel-references"
            role="tabpanel"
            aria-labelledby="tab-references"
            class="tab-panel"
          >
            <div class="references-container">
              <h3 class="references-title">External References</h3>
              <div class="references-list" x-show="vulnerability?.references?.length">
                <template x-for="reference in vulnerability?.references" :key="reference.url">
                  <div class="reference-item">
                    <a :href="reference.url" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       class="reference-link">
                      <span class="reference-url" x-text="reference.url"></span>
                      <span class="external-link-icon" aria-hidden="true">↗</span>
                    </a>
                    <div class="reference-source" x-show="reference.source" x-text="'Source: ' + reference.source"></div>
                    <div class="reference-tags" x-show="reference.tags?.length">
                      <template x-for="tag in reference.tags" :key="tag">
                        <span class="reference-tag" x-text="tag"></span>
                      </template>
                    </div>
                  </div>
                </template>
              </div>
              <div x-show="!vulnerability?.references?.length" class="no-references">
                <p>No external references available for this CVE.</p>
              </div>

              <!-- Official Links -->
              <div class="official-links">
                <h4>Official CVE Resources</h4>
                <ul class="official-links-list">
                  <li>
                    <a :href="'https://cve.mitre.org/cgi-bin/cvename.cgi?name=' + vulnerability?.cveId" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       class="official-link">
                      MITRE CVE Database
                      <span class="external-link-icon" aria-hidden="true">↗</span>
                    </a>
                  </li>
                  <li>
                    <a :href="'https://nvd.nist.gov/vuln/detail/' + vulnerability?.cveId" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       class="official-link">
                      NIST NVD Database
                      <span class="external-link-icon" aria-hidden="true">↗</span>
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <footer class="modal-footer" x-show="!loading && !error && vulnerability">
        <div class="footer-actions">
          <button @click="closeModal()" class="btn btn-secondary" type="button">
            Close
          </button>
          <a :href="'/vuln-bot/api/vulns/' + vulnerability?.cveId + '.json'" 
             target="_blank" 
             class="btn btn-primary"
             :aria-label="'Download JSON data for ' + vulnerability?.cveId">
            View JSON
            <span class="external-link-icon" aria-hidden="true">↗</span>
          </a>
        </div>
        <div class="keyboard-hints">
          <span class="hint">Press <kbd>Esc</kbd> to close</span>
          <span class="hint">Use <kbd>Alt+1-4</kbd> to switch tabs</span>
        </div>
      </footer>
    </div>
  </div>
</div>